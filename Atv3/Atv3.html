<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestão de Produtos (Estilo WS04)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 20px; line-height:1.5; }
    h1 { margin-bottom: 8px; }
    .wrapper { max-width: 980px; margin: 0 auto; }
    form { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; align-items: end; margin-bottom: 18px; padding: 14px; border: 1px solid #ccc; border-radius: 8px; background:#f9f9f9; }
    label { display:block; font-size: 0.9rem; margin-bottom:3px; }
    input[type="text"], input[type="number"], textarea, select { width:100%; padding:7px; border:1px solid #bbb; border-radius:6px; }
    textarea { resize: vertical; min-height:65px; }
    .full { grid-column: 1 / -1; }
    .actions { display:flex; gap:6px; }
    button { padding:7px 12px; border-radius:6px; border: none; cursor:pointer; }
    button.primary { background:#0069d9; color:white; }
    button.warn { background:#ffb500; color:#222; }
    button.danger { background:#d33a3a; color:white; }
    table { width:100%; border-collapse: collapse; margin-top: 14px; }
    th, td { padding:8px; border:1px solid #eee; text-align:left; font-size:0.94rem; }
    tr:hover { background:#f1f1f1; }
    .small { font-size:0.84rem; color:#555; }
    .notice { margin-bottom:12px; color:#333; }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Gestão de Produtos</h1>
    <p class="notice small">Preencha o formulário para criar, atualizar ou remover produtos. Backend REST será usado, ou localStorage se não disponível.</p>

    <form id="formProduto">
      <!-- ID opcional para atualização/exclusão -->
      <div>
        <label for="produtoId">ID (vazio para novo)</label>
        <input type="text" id="produtoId" name="produtoId" placeholder="Ex: 1001" />
      </div>

      <div>
        <label for="produtoNome">Nome</label>
        <input type="text" id="produtoNome" name="produtoNome" required />
      </div>

      <div>
        <label for="produtoPreco">Preço (R$)</label>
        <input type="number" id="produtoPreco" name="produtoPreco" step="0.01" min="0" required />
      </div>

      <div>
        <label for="produtoQtd">Quantidade</label>
        <input type="number" id="produtoQtd" name="produtoQtd" min="0" required />
      </div>

      <div>
        <label for="produtoCategoria">Categoria</label>
        <select id="produtoCategoria" name="produtoCategoria">
          <option value="">— Selecione —</option>
          <option>Eletronicos</option>
          <option>Vestuario</option>
          <option>Alimentos</option>
          <option>Casa</option>
        </select>
      </div>

      <div>
        <label for="produtoDisponivel">Disponivel</label>
        <select id="produtoDisponivel" name="produtoDisponivel">
          <option value="true">Sim</option>
          <option value="false">Nao</option>
        </select>
      </div>

      <div class="full">
        <label for="produtoDesc">Descricao</label>
        <textarea id="produtoDesc" name="produtoDesc"></textarea>
      </div>

      <div class="full actions">
        <button type="submit" id="btnSalvar" class="primary">Salvar</button>
        <button type="button" id="btnAtualizar" class="warn">Atualizar</button>
        <button type="button" id="btnExcluir" class="danger">Excluir</button>
        <button type="button" id="btnLimpar">Limpar</button>
        <button type="button" id="btnListar">Listar</button>
      </div>
    </form>

    <div id="msgInfo" class="small"></div>

    <table id="tblProdutos" aria-live="polite">
      <thead>
        <tr>
          <th>ID</th><th>Nome</th><th>Preco</th><th>Qtd</th><th>Categoria</th><th>Disponivel</th><th>Descricao</th><th>Acoes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    (function(){
      const API_URL = '/api';
      const RECURSO = 'produtos';
      const usarBackend = true;

      const form = document.getElementById('formProduto');
      const msgArea = document.getElementById('msgInfo');
      const corpoTabela = document.querySelector('#tblProdutos tbody');

      function exibirMsg(txt, duracao=3500){
        msgArea.textContent = txt;
        if(duracao>0) setTimeout(()=>{if(msgArea.textContent===txt) msgArea.textContent='';}, duracao);
      }

      function pegarProdutoDoForm(){
        const id = document.getElementById('produtoId').value.trim();
        return {
          id: id === '' ? null : id,
          nome: document.getElementById('produtoNome').value.trim(),
          preco: parseFloat(document.getElementById('produtoPreco').value),
          quantidade: parseInt(document.getElementById('produtoQtd').value,10),
          categoria: document.getElementById('produtoCategoria').value,
          disponivel: document.getElementById('produtoDisponivel').value==='true',
          descricao: document.getElementById('produtoDesc').value.trim()
        };
      }

      function colocarProdutoNoForm(p){
        document.getElementById('produtoId').value = p.id ?? '';
        document.getElementById('produtoNome').value = p.nome ?? '';
        document.getElementById('produtoPreco').value = p.preco!=null?p.preco:'';
        document.getElementById('produtoQtd').value = p.quantidade!=null?p.quantidade:'';
        document.getElementById('produtoCategoria').value = p.categoria ?? '';
        document.getElementById('produtoDisponivel').value = p.disponivel?'true':'false';
        document.getElementById('produtoDesc').value = p.descricao ?? '';
      }

      function limparFormulario(){ form.reset(); document.getElementById('produtoId').value=''; }

      // -------- localStorage --------
      const LS_CHAVE='ws04_produtos_local';

      function lsGetTodos(){ return JSON.parse(localStorage.getItem(LS_CHAVE)||'[]'); }
      function lsSalvarTodos(arr){ localStorage.setItem(LS_CHAVE,JSON.stringify(arr)); }
      function lsAdicionarProduto(p){
        const todos = lsGetTodos();
        if(!p.id){ const next=(todos.length===0)?1:(Math.max(...todos.map(x=>Number(x.id)))+1); p.id=String(next); }
        todos.push(p);
        lsSalvarTodos(todos);
        return p;
      }
      function lsAtualizarProduto(p){
        let todos=lsGetTodos();
        const idx=todos.findIndex(x=>String(x.id)===String(p.id));
        if(idx===-1) throw new Error('Produto nao encontrado (local).');
        todos[idx]=p;
        lsSalvarTodos(todos);
        return p;
      }
      function lsRemoverProduto(id){
        let todos=lsGetTodos();
        const idx=todos.findIndex(x=>String(x.id)===String(id));
        if(idx===-1) throw new Error('Produto nao encontrado (local).');
        todos.splice(idx,1);
        lsSalvarTodos(todos);
      }

      // -------- chamadas REST --------
      async function chamarApi(url, opts={}) {
        try{
          const res=await fetch(url,opts);
          if(!res.ok){
            let t=await res.text();
            throw new Error('Erro servidor: '+res.status+' '+res.statusText+(t?' — '+t:''));
          }
          const ct=res.headers.get('content-type')||'';
          if(ct.includes('application/json')) return await res.json();
          return null;
        } catch(e){ throw e; }
      }

      async function listarProdutos(){
        try{
          if(usarBackend){
            const data=await chamarApi(`${API_URL}/${RECURSO}`);
            renderTabela(Array.isArray(data)?data:[]);
            exibirMsg('Dados carregados do backend.');
            return;
          }
          throw new Error('Backend desativado');
        } catch(e){
          renderTabela(lsGetTodos());
          exibirMsg('Backend indisponível — usando dados locais.');
        }
      }

      async function salvarProduto(p){
        try{
          if(usarBackend){
            const criado=await chamarApi(`${API_URL}/${RECURSO}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
            exibirMsg('Produto cadastrado (backend).');
            return criado;
          }
          throw new Error('Backend desativado');
        } catch(e){
          const criado=lsAdicionarProduto(p);
          exibirMsg('Produto cadastrado (local).');
          return criado;
        }
      }

      async function atualizarProduto(p){
        try{
          if(usarBackend){
            const upd=await chamarApi(`${API_URL}/${RECURSO}/${encodeURIComponent(p.id)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
            exibirMsg('Produto atualizado (backend).');
            return upd;
          }
          throw new Error('Backend desativado');
        } catch(e){
          const upd=lsAtualizarProduto(p);
          exibirMsg('Produto atualizado (local).');
          return upd;
        }
      }

      async function excluirProduto(id){
        try{
          if(usarBackend){
            await chamarApi(`${API_URL}/${RECURSO}/${encodeURIComponent(id)}`,{method:'DELETE'});
            exibirMsg('Produto excluido (backend).');
            return;
          }
          throw new Error('Backend desativado');
        } catch(e){
          lsRemoverProduto(id);
          exibirMsg('Produto excluido (local).');
        }
      }

      // -------- render tabela --------
      function renderTabela(lista){
        corpoTabela.innerHTML='';
        if(!lista || lista.length===0){ corpoTabela.innerHTML='<tr><td colspan="8" class="small">Nenhum produto encontrado.</td></tr>'; return; }
        for(const p of lista){
          const tr=document.createElement('tr');
          const idCell=document.createElement('td'); idCell.textContent=p.id??'';
          const nomeCell=document.createElement('td'); nomeCell.textContent=p.nome??'';
          const precoCell=document.createElement('td'); precoCell.textContent=p.preco!=null?Number(p.preco).toFixed(2):'';
          const qtdCell=document.createElement('td'); qtdCell.textContent=p.quantidade??'';
          const catCell=document.createElement('td'); catCell.textContent=p.categoria??'';
          const dispCell=document.createElement('td'); dispCell.textContent=p.disponivel?'Sim':'Nao';
          const descCell=document.createElement('td'); descCell.textContent=p.descricao??'';

          const acoes=document.createElement('td');
          const btnCarregar=document.createElement('button'); btnCarregar.textContent='Carregar'; btnCarregar.style.marginRight='6px';
          btnCarregar.addEventListener('click',()=>colocarProdutoNoForm(p));
          const btnDel=document.createElement('button'); btnDel.textContent='X'; btnDel.className='danger';
          btnDel.addEventListener('click',async ()=>{if(!confirm('Confirma exclusao do produto ID '+p.id+'?')) return; try{await excluirProduto(p.id); await listarProdutos();}catch(e){exibirMsg('Erro ao excluir: '+e.message);}});

          acoes.appendChild(btnCarregar); acoes.appendChild(btnDel);

          tr.appendChild(idCell); tr.appendChild(nomeCell); tr.appendChild(precoCell); tr.appendChild(qtdCell);
          tr.appendChild(catCell); tr.appendChild(dispCell); tr.appendChild(descCell); tr.appendChild(acoes);

          corpoTabela.appendChild(tr);
        }
      }

      // -------- eventos --------
      form.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const p=pegarProdutoDoForm();
        if(!p.nome){ exibirMsg('Nome obrigatório'); return; }
        if(isNaN(p.preco)||p.preco<0){ exibirMsg('Preco inválido'); return; }
        if(isNaN(p.quantidade)||p.quantidade<0){ exibirMsg('Quantidade inválida'); return; }
        try{
          if(!p.id){ await salvarProduto(p); limparFormulario(); listarProdutos(); }
          else{ if(!confirm('ID preenchido — deseja salvar como novo produto com ID informado?')) return; await salvarProduto(p); limparFormulario(); listarProdutos(); }
        }catch(err){ exibirMsg('Erro ao salvar: '+(err.message||err));}
      });

      document.getElementById('btnAtualizar').addEventListener('click', async ()=>{
        const p=pegarProdutoDoForm();
        if(!p.id){ exibirMsg('Informe ID para atualizar.'); return; }
        try{await atualizarProduto(p); limparFormulario(); listarProdutos();}catch(err){exibirMsg('Erro ao atualizar: '+err.message);}
      });

      document.getElementById('btnExcluir').addEventListener('click', async ()=>{
        const id=document.getElementById('produtoId').value.trim();
        if(!id){ exibirMsg('Informe ID para exclusao.'); return; }
        if(!confirm('Confirma exclusao do ID '+id+'?')) return;
        try{await excluirProduto(id); limparFormulario(); listarProdutos();}catch(err){exibirMsg('Erro ao excluir: '+err.message);}
      });

      document.getElementById('btnLimpar').addEventListener('click', ()=>{ limparFormulario(); exibirMsg('Formulario limpo',1200); });
      document.getElementById('btnListar').addEventListener('click', listarProdutos);

      listarProdutos();

      (function seedLocal(){ if(!localStorage.getItem(LS_CHAVE)){ const exemplo=[{id:'1',nome:'Cabo USB-C',preco:29.90,quantidade:50,categoria:'Eletronicos',disponivel:true,descricao:'Cabo 1m'},{id:'2',nome:'Camiseta Basica',preco:39.90,quantidade:20,categoria:'Vestuario',disponivel:true,descricao:'Algodao'}]; localStorage.setItem(LS_CHAVE,JSON.stringify(exemplo)); } })();

    })();
  </script>
</body>
</html>
